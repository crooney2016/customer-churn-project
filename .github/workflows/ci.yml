name: CI - Tests and Linting

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run tests
        run: |
          pytest --cov=function_app --cov-report=xml --cov-report=term-missing -v

      - name: Generate test suite report
        run: |
          python3 scripts/generate_test_suite_report.py || true
        continue-on-error: true

      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Upload test suite report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-suite-report
          path: outputs/test-suite-report.md
          retention-days: 30
        continue-on-error: true

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run pylint
        run: |
          pylint function_app/ --fail-under=8.0 || true

      - name: Run pyright
        run: |
          pyright function_app/ || true

      - name: Run ruff check
        run: |
          ruff check . || true

      - name: Run ruff format check
        run: |
          ruff format --check . || true

  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install markdownlint (optional check)
        run: |
          npm install -g markdownlint-cli2 || echo "markdownlint-cli2 not available, skipping"

      - name: Run markdown fix script (dry-run)
        run: |
          python3 scripts/fix-markdown-lint.py --dry-run . || true

      - name: Check for markdown errors
        run: |
          # Run fix script and check if any files would be modified
          python3 scripts/fix-markdown-lint.py --dry-run . > /tmp/markdown-fix-output.txt 2>&1 || true
          
          # Check if script would fix any files
          if grep -q "Would fix:" /tmp/markdown-fix-output.txt; then
            echo "❌ Markdown linting errors found. Run 'python3 scripts/fix-markdown-lint.py .' to fix."
            cat /tmp/markdown-fix-output.txt
            exit 1
          else
            echo "✅ All markdown files are lint-free"
          fi

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run pyright
        run: |
          pyright function_app/
